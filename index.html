<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerrymander Puzzle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        :root {
            --color-party-0: #6366f1; /* Indigo */
            --color-party-1: #f97316; /* Orange */
            --color-party-2: #10b981; /* Emerald/Green */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overscroll-behavior: none;
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .game-grid {
            display: grid;
            gap: 2px;
            background-color: #94a3b8;
            border: 2px solid #94a3b8;
            border-radius: 8px;
            overflow: hidden;
            touch-action: none; 
            width: 95%;
            aspect-ratio: 1;
            margin: 10px auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .cell {
            background-color: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            flex-wrap: wrap;
            padding: 2px;
            gap: 2px;
        }

        .voter {
            width: 36%;
            height: 36%;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .bg-party-0 { background-color: var(--color-party-0); }
        .bg-party-1 { background-color: var(--color-party-1); }
        .bg-party-2 { background-color: var(--color-party-2); }
        
        .text-party-0 { color: var(--color-party-0); }
        .text-party-1 { color: var(--color-party-1); }
        .text-party-2 { color: var(--color-party-2); }

        .border-party-0 { border-color: var(--color-party-0); }
        .border-party-1 { border-color: var(--color-party-1); }
        .border-party-2 { border-color: var(--color-party-2); }
        
        .palette-btn {
            transition: transform 0.1s, border-color 0.1s;
            border: 3px solid transparent;
            position: relative;
            touch-action: manipulation;
            font-weight: 800;
            color: #475569;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        .palette-btn:active { transform: scale(0.95); }
        .palette-btn.active {
            transform: scale(1.15);
            border-color: #334155;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .palette-btn.edit-mode-active {
            border-style: dashed;
            border-color: #94a3b8;
            background-image: linear-gradient(45deg, rgba(255,255,255,0.5) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.5) 75%, transparent 75%, transparent);
            background-size: 10px 10px;
        }
        .palette-btn.pending-merge {
            border-color: #f59e0b; /* Amber */
            background-color: #fef3c7 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        
        .modal-overlay {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        .advantage-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            background: #f1f5f9;
            color: #64748b;
            font-weight: bold;
            margin-top: 2px;
            display: inline-block;
        }
        .advantage-active .advantage-badge {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }

        .badge-2x {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: #334155;
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 25;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .cell[data-border-top="true"] { border-top: 3px solid #334155; margin-top: -3px; z-index: 20; }
        .cell[data-border-bottom="true"] { border-bottom: 3px solid #334155; margin-bottom: -3px; z-index: 20; }
        .cell[data-border-left="true"] { border-left: 3px solid #334155; margin-left: -3px; z-index: 20; }
        .cell[data-border-right="true"] { border-right: 3px solid #334155; margin-right: -3px; z-index: 20; }
    </style>
</head>
<body class="min-h-screen flex flex-col no-select">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-2 flex justify-between items-center sticky top-0 z-40 shadow-sm h-14">
        <h1 class="text-lg font-bold tracking-tight text-slate-800">Redistrict<span class="text-indigo-600">Puzzle</span></h1>
        <div class="flex gap-2">
             <button onclick="app.openSettings()" class="bg-slate-100 text-slate-600 hover:text-slate-800 hover:bg-slate-200 p-2 rounded-lg transition" title="New Game Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
            <button onclick="app.toggleRules()" class="bg-slate-100 text-slate-600 hover:text-slate-800 hover:bg-slate-200 p-2 rounded-lg transition" title="Help">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
        </div>
    </header>

    <main class="flex-grow w-full flex flex-col items-center justify-start p-2 gap-2 max-w-lg mx-auto">
        
        <!-- Game Controls / Scoreboard -->
        <div class="w-full bg-white p-3 rounded-xl shadow-sm border border-slate-200 space-y-3">
            
            <!-- Header for Stats -->
            <div class="flex justify-center items-center bg-slate-50 p-2 rounded-lg">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Results Analysis Mode</span>
            </div>

            <!-- Scoreboard -->
            <div class="grid grid-cols-3 gap-2 text-center">
                <!-- Party 0 -->
                <div class="flex flex-col items-center p-2 rounded bg-indigo-50/50 border border-indigo-100" id="sb-panel-0">
                    <span class="text-2xl font-bold text-party-0 leading-none" id="score-0">0</span>
                    <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">Seats</span>
                    <span class="text-[9px] text-slate-400" id="total-pop-0">Pop: 0</span>
                    <div id="badge-0" class="hidden advantage-badge">Tie-Breaker</div>
                </div>
                <!-- Party 1 -->
                <div class="flex flex-col items-center p-2 rounded bg-orange-50/50 border border-orange-100" id="sb-panel-1">
                    <span class="text-2xl font-bold text-party-1 leading-none" id="score-1">0</span>
                    <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">Seats</span>
                    <span class="text-[9px] text-slate-400" id="total-pop-1">Pop: 0</span>
                    <div id="badge-1" class="hidden advantage-badge">Tie-Breaker</div>
                </div>
                <!-- Party 2 -->
                <div class="flex flex-col items-center p-2 rounded bg-emerald-50/50 border border-emerald-100" id="sb-panel-2">
                    <span class="text-2xl font-bold text-party-2 leading-none" id="score-2">0</span>
                    <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">Seats</span>
                    <span class="text-[9px] text-slate-400" id="total-pop-2">Pop: 0</span>
                    <div id="badge-2" class="hidden advantage-badge">Tie-Breaker</div>
                </div>
            </div>
            
            <!-- Status Text -->
            <div class="flex justify-between items-center gap-2">
                <button onclick="app.resetMap()" class="text-[10px] text-slate-500 font-bold hover:bg-slate-100 px-2 py-1 rounded transition">Reset Map</button>
                <div id="validation-msg" class="flex-1 text-center text-[10px] font-bold py-1 px-1 rounded bg-slate-100 text-slate-500 leading-tight truncate">
                    Loading...
                </div>
            </div>
        </div>

        <!-- The Grid -->
        <div id="game-grid" class="game-grid">
            <!-- Cells generated by JS -->
        </div>

        <!-- Controls Area -->
        <div class="w-full px-2">
            <!-- Palette & Size Toggle -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-3 w-full overflow-hidden relative">
                
                <!-- Size Toggle Button -->
                <div class="absolute top-2 right-2">
                    <button id="size-toggle-btn" onclick="app.toggleSizeEdit()" class="text-[10px] px-2 py-1 rounded bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 border border-slate-300 transition flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19a8 8 0 0 0 9.875-12.723M11 5a8 8 0 0 1-9.875 12.723"></path></svg>
                        Edit Sizes
                    </button>
                </div>

                <div class="flex justify-center flex-wrap gap-2 mb-3 mt-4" id="palette">
                    <!-- Generated by JS -->
                </div>
                
                <!-- Check Button -->
                <button onclick="app.checkMap()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-md active:bg-slate-900 transition flex items-center justify-center gap-2">
                    <span>Check Results</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-bounce-in">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                New Game Setup
            </h2>
            
            <div class="space-y-6 mb-6">
                <!-- Grid Size Input -->
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-bold text-slate-700">Grid Size</label>
                        <span id="setting-size-val" class="text-sm font-mono bg-slate-100 px-2 rounded text-slate-600">5 x 5</span>
                    </div>
                    <input type="range" min="4" max="10" value="5" id="setting-size" oninput="app.updateSettingsUI()">
                </div>

                <!-- District Count Input -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Number of Districts</label>
                    <div class="grid grid-cols-3 gap-2" id="setting-districts-container">
                        <!-- Filled by JS -->
                    </div>
                    <p class="text-xs text-slate-400 mt-2" id="setting-district-info">Target: 5 voters</p>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 transition">Cancel</button>
                <button onclick="app.generateNewGame()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg">Generate</button>
            </div>
        </div>
    </div>

    <!-- Modal: Info/Win -->
    <div id="info-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div id="info-modal-content" class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center animate-bounce-in transition-all duration-300">
            <div id="modal-icon" class="text-4xl mb-3">üó≥Ô∏è</div>
            <h2 id="modal-title" class="text-xl font-bold text-slate-800 mb-2">Title</h2>
            <div id="modal-body" class="text-sm text-slate-600 mb-6 space-y-3 text-left bg-slate-50 p-3 rounded-lg border border-slate-100">
                <!-- Content -->
            </div>
            <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl hover:bg-slate-900 transition shadow-md">
                Okay
            </button>
        </div>
    </div>

    <script>
        const app = function() {
            // Configuration & State
            let config = {
                gridSize: 5,
                numDistricts: 5,
                targetDistrictPop: 5,
                totalCells: 25,
                totalPopulation: 25,
                numParties: 3
            };
            
            let state = {
                grid: [], 
                currentTool: 1,
                isDragging: false,
                isLevelComplete: false,
                gridRect: null,
                colors: [],
                viewMode: 'edit',
                partyTotals: {0:0, 1:0, 2:0},
                minorityParty: -1,
                isEditingSizes: false,
                pendingMerge: null, // New State for Merging
                districtWeights: {}, 
                districtTargets: {} 
            };

            let els = {};

            // --- CORE LOGIC & HELPERS (Hoisted) ---

            function setTool(id) {
                state.currentTool = id;
                resetViewMode();
                if(els.palette) {
                    const btns = els.palette.children;
                    for (let i=0; i<btns.length; i++) {
                        const btn = btns[i];
                        // Don't remove pending-merge class here
                        if (parseInt(btn.dataset.id) === id) {
                            btn.classList.add('active');
                            btn.style.borderColor = '#334155';
                        } else {
                            btn.classList.remove('active');
                            btn.style.borderColor = 'transparent';
                        }
                    }
                }
                if (navigator.vibrate) navigator.vibrate(5);
            }

            function resetViewMode() {
                if (state.viewMode === 'results') {
                    state.viewMode = 'edit';
                    updateVisuals();
                }
            }

            function paintCell(index) {
                if (state.grid[index].districtId === state.currentTool) return;
                state.grid[index].districtId = state.currentTool;
                updateVisuals();
                updateGameState(false); 
                if (navigator.vibrate) navigator.vibrate(5);
            }

            function resetMap() {
                 state.grid.forEach(c => c.districtId = 0);
                 resetViewMode();
                 updateVisuals();
                 updateGameState(false);
            }

            function handleInput(clientX, clientY) {
                if(els.grid) state.gridRect = els.grid.getBoundingClientRect();
                if (!state.gridRect) return;
                
                const x = clientX - state.gridRect.left;
                const y = clientY - state.gridRect.top;
                
                if (x < 0 || x > state.gridRect.width || y < 0 || y > state.gridRect.height) return;

                const col = Math.floor((x / state.gridRect.width) * config.gridSize);
                const row = Math.floor((y / state.gridRect.height) * config.gridSize);
                const index = row * config.gridSize + col;

                if (index >= 0 && index < config.totalCells) {
                    paintCell(index);
                }
            }

            function checkContiguity(cells) {
                if (cells.length === 0) return true;
                const indices = new Set(cells.map(c => c.id));
                const start = cells[0].id;
                const queue = [start];
                const visited = new Set([start]);
                
                while(queue.length > 0) {
                    const curr = queue.shift();
                    const row = Math.floor(curr / config.gridSize);
                    const col = curr % config.gridSize;
                    
                    const neighbors = [
                        row > 0 ? curr - config.gridSize : -1,
                        row < config.gridSize - 1 ? curr + config.gridSize : -1,
                        col > 0 ? curr - 1 : -1,
                        col < config.gridSize - 1 ? curr + 1 : -1
                    ];
                    
                    neighbors.forEach(n => {
                        if (n !== -1 && indices.has(n) && !visited.has(n)) {
                            visited.add(n);
                            queue.push(n);
                        }
                    });
                }
                return visited.size === indices.size;
            }

            function getDistrictWinners(cells, weight) {
                if (cells.length === 0) return [];
                let counts = {0:0, 1:0, 2:0};
                cells.forEach(c => {
                    c.voters.forEach(v => { counts[v]++; });
                });
                
                // Convert to array for sorting: [{id: 0, count: 5}, ...]
                let parties = [
                    {id: 0, count: counts[0]},
                    {id: 1, count: counts[1]},
                    {id: 2, count: counts[2]}
                ];
                
                // Sort by count DESC
                parties.sort((a,b) => b.count - a.count);
                
                if (weight === 1) {
                    // Logic for 1x: Top winner, or minority if tied
                    let top = parties[0];
                    let winners = parties.filter(p => p.count === top.count).map(p => p.id);
                    if (winners.length === 1) return [winners[0]];
                    // Tie logic
                    if (winners.includes(state.minorityParty)) return [state.minorityParty];
                    return [-1]; // tie
                } else {
                    // Logic for 2x: Two seats
                    // If no votes, return empty
                    if(parties[0].count === 0) return [-1, -1];

                    // Candidate 1: Clear winner
                    let seat1 = parties[0].id;
                    
                    // Candidate 2: Second place
                    let seat2 = parties[1].id;
                    
                    // Specific logic constraint: "It shouldn't be two seats from the same party."
                    // Since parties are distinct (0, 1, 2), seat1 and seat2 will naturally be different parties 
                    // UNLESS there is a tie for 1st place between two parties.
                    
                    // Case: Tie for 1st (e.g., A:10, B:10, C:2) -> A and B get seats.
                    // Case: Clear winner (e.g. A:20, B:5, C:2) -> A and B get seats.
                    // Case: A:20, B:0, C:0 -> A gets seat 1. Seat 2?
                    // "It shouldn't be two seats from the same party" implies we enforce diversity.
                    // If parties[1].count is 0, do they still get a seat?
                    // Let's assume yes, to fulfill the "two seats from different parties" rule.
                    
                    // Handle Tie for 2nd place (e.g. A:20, B:5, C:5) -> Who gets seat 2?
                    // Minority rule check for seat 2
                    if (parties[1].count === parties[2].count) {
                        let potential2nds = [parties[1].id, parties[2].id];
                        if (potential2nds.includes(state.minorityParty)) {
                            seat2 = state.minorityParty;
                        }
                    }
                    
                    return [seat1, seat2];
                }
            }

            function updateVisuals() {
                if(!els.grid) return;
                const domCells = els.grid.children;
                
                let districtWinners = {};
                if (state.viewMode === 'results') {
                    for(let i=1; i<=config.numDistricts; i++) {
                        const cells = state.grid.filter(c => c.districtId === i);
                        const weight = state.districtWeights[i];
                        districtWinners[i] = getDistrictWinners(cells, weight);
                    }
                }

                state.grid.forEach((c, i) => {
                    const el = domCells[i];
                    const dId = c.districtId;

                    if (dId === 0) {
                        el.style.backgroundColor = '#ffffff';
                        el.style.background = 'none';
                        el.style.backgroundColor = '#ffffff';
                    } else {
                        if (state.viewMode === 'results') {
                            const winners = districtWinners[dId];
                            const weight = state.districtWeights[dId];
                            
                            // Map party ID to color
                            const getColor = (id) => {
                                if(id===0) return '#e0e7ff';
                                if(id===1) return '#ffedd5';
                                if(id===2) return '#d1fae5';
                                return '#f1f5f9';
                            };

                            if (weight === 1) {
                                el.style.background = 'none';
                                el.style.backgroundColor = getColor(winners[0]);
                            } else {
                                // 2x District - Gradient
                                const c1 = getColor(winners[0]);
                                const c2 = getColor(winners[1]);
                                el.style.background = `linear-gradient(135deg, ${c1} 50%, ${c2} 50%)`;
                            }
                        } else {
                            el.style.background = 'none';
                            el.style.backgroundColor = state.colors[dId - 1];
                        }
                    }
                    
                    // Borders
                    if (dId === 0) {
                        el.removeAttribute('data-border-top');
                        el.removeAttribute('data-border-bottom');
                        el.removeAttribute('data-border-left');
                        el.removeAttribute('data-border-right');
                    } else {
                        const row = Math.floor(i / config.gridSize);
                        const col = i % config.gridSize;
                        
                        const nTop = row > 0 ? state.grid[i - config.gridSize] : null;
                        const nBottom = row < config.gridSize - 1 ? state.grid[i + config.gridSize] : null;
                        const nLeft = col > 0 ? state.grid[i - 1] : null;
                        const nRight = col < config.gridSize - 1 ? state.grid[i + 1] : null;
                        
                        el.dataset.borderTop = (nTop && nTop.districtId !== dId) ? "true" : "false";
                        el.dataset.borderBottom = (nBottom && nBottom.districtId !== dId) ? "true" : "false";
                        el.dataset.borderLeft = (nLeft && nLeft.districtId !== dId) ? "true" : "false";
                        el.dataset.borderRight = (nRight && nRight.districtId !== dId) ? "true" : "false";
                    }
                });
            }

            function updateGameState(triggerWin = false) {
                const districts = {};
                for(let i=1; i<=config.numDistricts; i++) districts[i] = [];
                
                let unassigned = 0;
                state.grid.forEach(c => {
                    if (c.districtId !== 0) districts[c.districtId].push(c);
                    else unassigned++;
                });

                let wins0 = 0, wins1 = 0, wins2 = 0;
                let invalidSize = false;
                let broken = false;

                for (let i = 1; i <= config.numDistricts; i++) {
                    const cells = districts[i];
                    
                    const distPop = cells.reduce((sum, c) => sum + c.voters.length, 0);
                    const target = state.districtTargets[i];

                    const counterEl = document.getElementById(`dist-count-${i}`);
                    if (counterEl) {
                        counterEl.innerText = `${distPop}/${target}`;
                        if (distPop === target) {
                             counterEl.className = "text-[9px] sm:text-[10px] leading-none font-bold text-slate-800";
                        } else if (distPop > target) {
                             counterEl.className = "text-[9px] sm:text-[10px] leading-none font-bold text-red-700";
                        } else {
                             counterEl.className = "text-[9px] sm:text-[10px] leading-none font-bold opacity-60";
                        }
                    }
                    
                    if (distPop !== target) invalidSize = true;
                    if (cells.length > 0 && !checkContiguity(cells)) broken = true;

                    const weight = state.districtWeights[i];
                    const winners = getDistrictWinners(cells, weight);
                    
                    winners.forEach(w => {
                        if(w === 0) wins0++;
                        if(w === 1) wins1++;
                        if(w === 2) wins2++;
                    });
                }

                els.score0.innerText = wins0;
                els.score1.innerText = wins1;
                els.score2.innerText = wins2;
                
                if (unassigned > 0) {
                    els.validationMsg.innerText = `Assign blocks: ${config.totalCells - unassigned}/${config.totalCells}`;
                    els.validationMsg.className = "flex-1 text-center text-[10px] font-bold py-1 px-1 rounded bg-slate-50 text-slate-400";
                } else if (invalidSize) {
                    els.validationMsg.innerText = `Check Capacities`;
                    els.validationMsg.className = "flex-1 text-center text-[10px] font-bold py-1 px-1 rounded bg-red-100 text-red-600";
                } else if (broken) {
                    els.validationMsg.innerText = "Districts must be connected";
                    els.validationMsg.className = "flex-1 text-center text-[10px] font-bold py-1 px-1 rounded bg-red-100 text-red-600";
                } else {
                    els.validationMsg.innerText = "Valid Map - Check Results";
                    els.validationMsg.className = "flex-1 text-center text-[10px] font-bold py-1 px-1 rounded bg-green-100 text-green-700";
                }

                return { wins0, wins1, wins2, invalidSize, broken, unassigned };
            }

            function getDistrictSquares() {
                let html = '';
                for(let i=1; i<=config.numDistricts; i++) {
                    const cells = state.grid.filter(c => c.districtId === i);
                    const weight = state.districtWeights[i];
                    const winners = getDistrictWinners(cells, weight);
                    
                    // Render squares for winners
                    // For 1x: 1 square
                    // For 2x: 2 squares (winner 1 and winner 2)
                    
                    const getBg = (w) => {
                        if(w===0) return "bg-indigo-500";
                        if(w===1) return "bg-orange-500";
                        if(w===2) return "bg-emerald-500";
                        return "bg-slate-200";
                    };

                    html += `<div class="${getBg(winners[0])} h-6 rounded flex items-center justify-center text-white text-[10px] font-bold relative">${i} ${weight>1 ? '<span class="absolute -top-1 -right-1 bg-slate-800 text-[6px] px-1 rounded-full">2x</span>':''}</div>`;
                    if(weight > 1) {
                         html += `<div class="${getBg(winners[1])} h-6 rounded flex items-center justify-center text-white text-[10px] font-bold opacity-80">${i}</div>`;
                    }
                }
                return html;
            }

            // --- RESTORED HELPER FUNCTIONS ---

            function setupDOM() {
                els.grid.style.gridTemplateColumns = `repeat(${config.gridSize}, 1fr)`;
                els.grid.innerHTML = '';

                state.grid.forEach((cellData, i) => {
                    const cell = document.createElement('div');
                    const pop = cellData.voters.length;
                    cell.className = `cell pop-${pop}`;
                    cell.style.backgroundColor = '#ffffff'; 
                    
                    cellData.voters.forEach(party => {
                        const voter = document.createElement('div');
                        let colorClass = 'bg-slate-300';
                        if(party === 0) colorClass = 'bg-party-0';
                        if(party === 1) colorClass = 'bg-party-1';
                        if(party === 2) colorClass = 'bg-party-2';
                        voter.className = `voter ${colorClass}`;
                        cell.appendChild(voter);
                    });
                    
                    els.grid.appendChild(cell);
                });

                setupPaletteUI();
                
                setTool(1);
                attachEvents();
                setTimeout(() => { state.gridRect = els.grid.getBoundingClientRect(); }, 50);
            }

            function attachEvents() {
                if(!els.grid) return;
                els.grid.onmousedown = (e) => { 
                    resetViewMode(); 
                    state.isDragging = true; 
                    handleInput(e.clientX, e.clientY); 
                };
                window.onmouseup = () => { state.isDragging = false; };
                window.onmousemove = (e) => { if (state.isDragging) handleInput(e.clientX, e.clientY); };

                els.grid.ontouchstart = (e) => {
                    resetViewMode();
                    state.isDragging = true;
                    state.gridRect = els.grid.getBoundingClientRect();
                    if(e.cancelable) e.preventDefault();
                    handleInput(e.touches[0].clientX, e.touches[0].clientY);
                };
                els.grid.ontouchmove = (e) => {
                    if (!state.isDragging) return;
                    if(e.cancelable) e.preventDefault();
                    handleInput(e.touches[0].clientX, e.touches[0].clientY);
                };
                window.ontouchend = () => { state.isDragging = false; };
            }

            // --- INIT ---

            function init() {
                els = {
                    grid: document.getElementById('game-grid'),
                    score0: document.getElementById('score-0'),
                    score1: document.getElementById('score-1'),
                    score2: document.getElementById('score-2'),
                    totalPop0: document.getElementById('total-pop-0'),
                    totalPop1: document.getElementById('total-pop-1'),
                    totalPop2: document.getElementById('total-pop-2'),
                    validationMsg: document.getElementById('validation-msg'),
                    palette: document.getElementById('palette'),
                    sizeToggleBtn: document.getElementById('size-toggle-btn'),
                    settingsModal: document.getElementById('settings-modal'),
                    infoModal: document.getElementById('info-modal'),
                    infoModalContent: document.getElementById('info-modal-content'), 
                    modalTitle: document.getElementById('modal-title'),
                    modalBody: document.getElementById('modal-body'),
                    modalIcon: document.getElementById('modal-icon'),
                    settingSize: document.getElementById('setting-size'),
                    settingSizeVal: document.getElementById('setting-size-val'),
                    settingDistrictContainer: document.getElementById('setting-districts-container'),
                    settingDistrictInfo: document.getElementById('setting-district-info')
                };

                generateNewGame(); 
                
                window.addEventListener('resize', () => {
                    state.gridRect = els.grid.getBoundingClientRect();
                });
                
                setTimeout(() => {
                    showModal('Sandbox Mode', `
                        <p class="mb-2"><strong>Goal:</strong> Experiment with district boundaries.</p>
                        <p class="mb-2"><strong>New:</strong> Use <span class="font-bold bg-slate-200 text-slate-700 px-1 rounded text-xs">Edit Sizes</span> to create <span class="font-bold text-indigo-600">Multi-Member Districts (2x)</span>.</p>
                        <p class="text-xs text-slate-500 mt-2 bg-slate-50 p-2 rounded"><strong>How to create 2x:</strong><br>1. Enable "Edit Sizes"<br>2. Click District A (Keeps seat)<br>3. Click District B (Deletes seat)</p>
                    `, 'üó∫Ô∏è');
                }, 300);
            }

            // --- SETUP ---

            function updateSettingsUI() {
                const size = parseInt(els.settingSize.value);
                els.settingSizeVal.innerText = `${size} x ${size}`;
                const totalPop = size * size; 
                
                let validCounts = [];
                for (let i = 2; i <= totalPop / 2; i++) {
                    if (totalPop % i === 0) {
                        let dSize = totalPop / i;
                        if (dSize >= 3 && i >= 2) validCounts.push(i);
                    }
                }
                
                els.settingDistrictContainer.innerHTML = '';
                
                validCounts.forEach((count, idx) => {
                    const btn = document.createElement('button');
                    const dPop = totalPop / count;
                    btn.className = `p-2 rounded border text-sm font-bold transition ${
                        (idx === Math.floor(validCounts.length/2)) ? 'bg-indigo-100 border-indigo-300 text-indigo-700 ring-2 ring-indigo-200' : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100'
                    }`;
                    btn.onclick = (e) => {
                        document.querySelectorAll('#setting-districts-container button').forEach(b => {
                            b.className = 'p-2 rounded border border-slate-200 bg-slate-50 text-slate-600 text-sm font-bold hover:bg-slate-100 transition';
                        });
                        e.target.className = 'p-2 rounded border border-indigo-300 bg-indigo-100 text-indigo-700 text-sm font-bold ring-2 ring-indigo-200 transition';
                        els.settingDistrictInfo.innerText = `Target: ${dPop} voters per district`;
                        config.nextNumDistricts = count;
                    };
                    btn.innerText = count;
                    els.settingDistrictContainer.appendChild(btn);
                    
                    if (idx === Math.floor(validCounts.length/2)) {
                        config.nextNumDistricts = count;
                        els.settingDistrictInfo.innerText = `Target: ${dPop} voters per district`;
                    }
                });
            }

            function openSettings() {
                updateSettingsUI();
                els.settingsModal.classList.remove('hidden');
            }

            function generateNewGame() {
                if (els.settingSize.value) {
                    config.gridSize = parseInt(els.settingSize.value);
                    if (config.nextNumDistricts) config.numDistricts = config.nextNumDistricts;
                    else {
                        const total = config.gridSize * config.gridSize;
                        if (total % config.gridSize === 0) config.numDistricts = config.gridSize;
                        else config.numDistricts = 5; 
                    }
                }
                
                config.totalCells = config.gridSize * config.gridSize;
                config.totalPopulation = config.totalCells; 
                config.targetDistrictPop = Math.floor(config.totalPopulation / config.numDistricts);
                
                els.settingsModal.classList.add('hidden');

                state.districtWeights = {};
                for(let i=1; i<=config.numDistricts; i++) state.districtWeights[i] = 1;
                state.isEditingSizes = false;
                state.pendingMerge = null; // Reset
                updateToggleBtnUI();

                state.colors = [];
                for (let i = 0; i < config.numDistricts; i++) {
                    const hue = Math.floor((360 / config.numDistricts) * i + 20); 
                    state.colors.push(`hsl(${hue}, 85%, 85%)`);
                }

                let populations = new Array(config.totalCells).fill(1);
                const mutations = Math.floor(config.totalCells * 0.7); 
                for(let k=0; k<mutations; k++) {
                    const src = Math.floor(Math.random() * config.totalCells);
                    const row = Math.floor(src / config.gridSize);
                    const col = src % config.gridSize;
                    const neighbors = [];
                    if(row > 0) neighbors.push(src - config.gridSize);
                    if(row < config.gridSize-1) neighbors.push(src + config.gridSize);
                    if(col > 0) neighbors.push(src - 1);
                    if(col < config.gridSize-1) neighbors.push(src + 1);
                    const dest = neighbors[Math.floor(Math.random() * neighbors.length)];
                    if (populations[src] > 0 && populations[dest] < 2) {
                        populations[src]--;
                        populations[dest]++;
                    }
                }

                const p1 = Math.floor(Math.random() * (config.totalPopulation * 0.4)) + Math.floor(config.totalPopulation * 0.2);
                const remaining = config.totalPopulation - p1;
                const p2 = Math.floor(Math.random() * (remaining * 0.6)) + Math.floor(remaining * 0.2);
                const p3 = config.totalPopulation - p1 - p2;

                let voterPool = [];
                for(let i=0; i<p1; i++) voterPool.push(0);
                for(let i=0; i<p2; i++) voterPool.push(1);
                for(let i=0; i<p3; i++) voterPool.push(2);
                
                for (let i = voterPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [voterPool[i], voterPool[j]] = [voterPool[j], voterPool[i]];
                }

                state.partyTotals = {0: p1, 1: p2, 2: p3};
                const minVal = Math.min(p1, p2, p3);
                if (p1 === minVal) state.minorityParty = 0;
                else if (p2 === minVal) state.minorityParty = 1;
                else state.minorityParty = 2;

                els.totalPop0.innerText = `Pop: ${p1}`;
                els.totalPop1.innerText = `Pop: ${p2}`;
                els.totalPop2.innerText = `Pop: ${p3}`;
                
                [0,1,2].forEach(i => {
                    const badge = document.getElementById(`badge-${i}`);
                    const panel = document.getElementById(`sb-panel-${i}`);
                    if (i === state.minorityParty) {
                        badge.classList.remove('hidden');
                        panel.classList.add('advantage-active');
                    } else {
                        badge.classList.add('hidden');
                        panel.classList.remove('advantage-active');
                    }
                });

                let poolIndex = 0;
                state.grid = populations.map((pop, i) => {
                    let cellVoters = [];
                    for(let k=0; k<pop; k++) {
                        if(poolIndex < voterPool.length) {
                            cellVoters.push(voterPool[poolIndex]);
                            poolIndex++;
                        }
                    }
                    return { id: i, voters: cellVoters, districtId: 0 };
                });

                state.currentTool = 1;
                state.isLevelComplete = false;
                state.viewMode = 'edit';

                calculateDistrictTargets();
                setupDOM();
                updateGameState(false); 
            }

            function calculateDistrictTargets() {
                let totalWeight = 0;
                for(let i=1; i<=config.numDistricts; i++) totalWeight += state.districtWeights[i];
                const unitSize = Math.floor(config.totalPopulation / totalWeight);
                let remainder = config.totalPopulation % totalWeight;
                state.districtTargets = {};
                for(let i=1; i<=config.numDistricts; i++) {
                    let target = unitSize * state.districtWeights[i];
                    if (remainder > 0) {
                        target += 1;
                        remainder--;
                    }
                    state.districtTargets[i] = target;
                }
            }

            function toggleSizeEdit() {
                state.isEditingSizes = !state.isEditingSizes;
                state.pendingMerge = null; // Clear pending state
                updateToggleBtnUI();
                setupPaletteUI();
            }

            function updateToggleBtnUI() {
                if(state.isEditingSizes) {
                    els.sizeToggleBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-300');
                    els.sizeToggleBtn.classList.remove('bg-slate-100', 'text-slate-600', 'border-slate-300');
                    els.sizeToggleBtn.innerHTML = `Done`;
                } else {
                    els.sizeToggleBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-300');
                    els.sizeToggleBtn.classList.add('bg-slate-100', 'text-slate-600', 'border-slate-300');
                    els.sizeToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19a8 8 0 0 0 9.875-12.723M11 5a8 8 0 0 1-9.875 12.723"></path></svg> Edit Sizes`;
                }
            }

            function setupPaletteUI() {
                els.palette.innerHTML = '';
                for (let i = 1; i <= config.numDistricts; i++) {
                    const btn = document.createElement('button');
                    let baseClass = 'palette-btn w-12 h-12 sm:w-14 sm:h-14 rounded-full flex flex-col items-center justify-center shadow-sm transition-all relative';
                    
                    if (state.isEditingSizes) {
                        baseClass += ' edit-mode-active cursor-pointer transform hover:scale-105';
                        if(state.pendingMerge === i) baseClass += ' pending-merge';
                    }
                    
                    btn.className = baseClass;
                    btn.dataset.id = i;
                    const color = state.colors[i-1];
                    btn.style.backgroundColor = color;
                    let badge = '';
                    if (state.districtWeights[i] === 2) {
                        badge = `<div class="badge-2x">2x</div>`;
                    }
                    const target = state.districtTargets[i] || 0;
                    btn.innerHTML = `
                        <span class="text-sm sm:text-base leading-none">${i}</span>
                        <span id="dist-count-${i}" class="text-[9px] sm:text-[10px] leading-none font-bold opacity-70">0/${target}</span>
                        ${badge}
                    `;
                    btn.onpointerdown = (e) => {
                        if (state.isEditingSizes) {
                            handleMergeInteraction(i);
                        } else {
                            setTool(i);
                        }
                    };
                    els.palette.appendChild(btn);
                }
                if(!state.isEditingSizes) setTool(state.currentTool);
            }

            function handleMergeInteraction(id) {
                // Scenario 1: Un-merge a 2x district
                if (state.districtWeights[id] === 2) {
                    // Split back to 1x
                    state.districtWeights[id] = 1;
                    
                    // Create new district
                    config.numDistricts++;
                    state.districtWeights[config.numDistricts] = 1;
                    // Add new color
                    const hue = Math.floor((360 / config.numDistricts) * config.numDistricts + 20); 
                    state.colors.push(`hsl(${hue}, 85%, 85%)`);
                    
                    // Reset pending state
                    state.pendingMerge = null;
                    
                    calculateDistrictTargets();
                    setupPaletteUI();
                    updateGameState(false);
                    return;
                }

                // Scenario 2: Selecting first district for merge
                if (state.pendingMerge === null) {
                    state.pendingMerge = id;
                    // Update UI to show selection
                    setupPaletteUI();
                    return;
                }

                // Scenario 3: Selecting second district to delete
                if (state.pendingMerge !== null) {
                    const keepId = state.pendingMerge;
                    const deleteId = id;

                    if (keepId === deleteId) {
                        // Cancel
                        state.pendingMerge = null;
                        setupPaletteUI();
                        return;
                    }

                    // Perform Merge
                    state.districtWeights[keepId] = 2;
                    
                    // Re-assign cells of deleted district to 0
                    state.grid.forEach(c => {
                        if (c.districtId === deleteId) c.districtId = 0;
                        // Shift IDs down for anything higher than deleted
                        if (c.districtId > deleteId) c.districtId--;
                    });

                    // Shift Weights down
                    for(let k=deleteId; k < config.numDistricts; k++) {
                        state.districtWeights[k] = state.districtWeights[k+1];
                    }
                    delete state.districtWeights[config.numDistricts];
                    
                    // Shift Colors (remove color of deleted district to keep palette consistent?)
                    // Actually simpler to just remove the last color, or remove the specific index.
                    // state.colors corresponds to index i-1.
                    state.colors.splice(deleteId - 1, 1);

                    config.numDistricts--;
                    state.pendingMerge = null;
                    
                    // Reset tool if we deleted the current tool
                    state.currentTool = 1;

                    calculateDistrictTargets();
                    setupPaletteUI();
                    updateVisuals(); // Update grid colors since IDs changed
                    updateGameState(false);
                }
            }

            function checkMap() {
                const status = updateGameState(false); 
                
                if (status.unassigned > 0) {
                    showModal('Map Issue', `<p class="text-red-600 font-bold">Incomplete Map</p><p>You must assign all ${config.totalCells} blocks to a district.</p>`, '‚ö†Ô∏è');
                    return;
                }
                if (status.invalidSize) {
                    showModal('Map Issue', `<p class="text-red-600 font-bold">Uneven Population</p><p>Check the numbers on the palette buttons. Each district must hit its target exact target.</p>`, '‚öñÔ∏è');
                    return;
                }
                if (status.broken) {
                    showModal('Map Issue', `<p class="text-red-600 font-bold">Broken Districts</p><p>Districts must be connected.</p>`, 'üß©');
                    return;
                }

                state.viewMode = 'results';
                updateVisuals();
                
                let totalSeats = 0;
                for(let k in state.districtWeights) totalSeats += state.districtWeights[k];

                const totalVotes = state.partyTotals[0] + state.partyTotals[1] + state.partyTotals[2];
                const getPct = (val, total) => total > 0 ? Math.round((val/total)*100) : 0;

                const parties = [
                    { name: "Indigo", id: 0, color: "text-indigo-600", bg: "bg-indigo-50", wins: status.wins0 },
                    { name: "Orange", id: 1, color: "text-orange-600", bg: "bg-orange-50", wins: status.wins1 },
                    { name: "Green",  id: 2, color: "text-emerald-600", bg: "bg-emerald-50", wins: status.wins2 }
                ];

                let comparisonRows = '';
                parties.forEach(p => {
                    const votes = state.partyTotals[p.id];
                    const votePct = getPct(votes, totalVotes);
                    const seatPct = getPct(p.wins, totalSeats);
                    const diff = seatPct - votePct;
                    let note = "";
                    if (diff > 0) note = `<span class="text-[10px] text-green-600 font-bold ml-1">(+${diff}%)</span>`;
                    else if (diff < 0) note = `<span class="text-[10px] text-red-500 ml-1">(${diff}%)</span>`;

                    comparisonRows += `
                        <div class="grid grid-cols-3 gap-2 text-xs items-center p-2 rounded mb-1 border-b border-slate-100 last:border-0 hover:bg-slate-50">
                            <div class="font-bold ${p.color}">${p.name}</div>
                            <div class="text-center text-slate-600">${votePct}%</div>
                            <div class="text-right font-bold text-slate-800 flex justify-end items-center">
                                ${seatPct}% ${note}
                            </div>
                        </div>
                    `;
                });

                let districtRows = '';
                for(let i=1; i<=config.numDistricts; i++) {
                    const cells = state.grid.filter(c => c.districtId === i);
                    let counts = {0:0, 1:0, 2:0};
                    cells.forEach(c => c.voters.forEach(v => counts[v]++));
                    const distTotal = counts[0] + counts[1] + counts[2];
                    
                    const p0 = distTotal > 0 ? Math.round((counts[0]/distTotal)*100) : 0;
                    const p1 = distTotal > 0 ? Math.round((counts[1]/distTotal)*100) : 0;
                    const p2 = distTotal > 0 ? Math.round((counts[2]/distTotal)*100) : 0;
                    
                    const weight = state.districtWeights[i];
                    const winners = getDistrictWinners(cells, weight);
                    
                    const getBadge = (w) => {
                        if(w===0) return `<span class="text-indigo-700 font-bold">Ind</span>`;
                        if(w===1) return `<span class="text-orange-700 font-bold">Org</span>`;
                        if(w===2) return `<span class="text-emerald-700 font-bold">Grn</span>`;
                        return `<span class="text-slate-400">Tie</span>`;
                    };

                    let winnerBadges = getBadge(winners[0]);
                    if(weight > 1) {
                        winnerBadges += ` + ${getBadge(winners[1])}`;
                    }

                    districtRows += `
                        <div class="flex items-center justify-between text-[10px] p-2 rounded bg-white border border-slate-100 shadow-sm mb-1">
                            <div class="flex items-center gap-2">
                                <div class="font-bold text-slate-500 w-4 flex justify-center">${i}</div>
                                <div class="flex gap-2 font-mono leading-none">
                                    <span class="text-indigo-600 font-bold" title="Indigo">${p0}%</span>
                                    <span class="text-orange-600 font-bold" title="Orange">${p1}%</span>
                                    <span class="text-emerald-600 font-bold" title="Green">${p2}%</span>
                                </div>
                            </div>
                            <div class="px-1.5 py-0.5 bg-slate-100 rounded text-[9px] flex items-center gap-1">
                                ${winnerBadges}
                            </div>
                        </div>
                    `;
                }

                els.infoModalContent.classList.remove('max-w-sm');
                els.infoModalContent.classList.add('max-w-2xl');

                showModal('Election Analysis', `
                    <div class="flex flex-col sm:flex-row gap-4 h-full">
                        <div class="flex-1">
                            <div class="mb-4">
                                <p class="text-sm text-slate-500 mb-2 font-bold uppercase tracking-wider">Seat Efficiency</p>
                                <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                                    <div class="grid grid-cols-3 gap-2 bg-slate-100 p-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider">
                                        <div>Party</div>
                                        <div class="text-center">Votes</div>
                                        <div class="text-right">Seats</div>
                                    </div>
                                    <div class="p-1">
                                        ${comparisonRows}
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">District Map</p>
                                <div class="grid grid-cols-5 gap-1.5 justify-center">
                                    ${getDistrictSquares()}
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 border-t sm:border-t-0 sm:border-l border-slate-200 pt-4 sm:pt-0 sm:pl-4 flex flex-col min-h-0">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 flex justify-between">
                                <span>District Breakdown</span>
                                <span class="font-mono text-[9px] opacity-60">I / O / G</span>
                            </p>
                            <div class="bg-slate-50 p-2 rounded-lg border border-slate-200 overflow-y-auto flex-1 max-h-60 sm:max-h-80 custom-scrollbar">
                                ${districtRows}
                            </div>
                        </div>
                    </div>

                    <div class="text-xs text-slate-500 text-center mt-4">
                        Tap grid to continue editing.
                    </div>
                `, 'üìä');
            }

            function showModal(title, html, icon) {
                if(title !== 'Election Analysis') {
                    els.infoModalContent.classList.add('max-w-sm');
                    els.infoModalContent.classList.remove('max-w-2xl');
                }
                els.modalTitle.innerText = title;
                els.modalBody.innerHTML = html;
                els.modalIcon.innerText = icon;
                els.infoModal.classList.remove('hidden');
            }
            
            function toggleRules() {
                init();
            }

            return {
                init, 
                setTool, 
                openSettings, 
                updateSettingsUI, 
                generateNewGame,
                resetMap,
                toggleRules,
                checkMap,
                toggleSizeEdit
            };
        }();

        window.onload = app.init;
    </script>
</body>
</html>
